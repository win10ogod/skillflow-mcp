# SkillFlow MCP è·¯ç”±å„ªåŒ– - è®Šæ›´èªªæ˜

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å¯¦ç¾äº†å…©å€‹é—œéµçš„æ€§èƒ½å„ªåŒ–ï¼Œé¡¯è‘—æå‡äº† SkillFlow MCP æœå‹™å™¨çš„éŸ¿æ‡‰é€Ÿåº¦å’Œå¯é æ€§ã€‚

---

## ğŸš€ ä¸»è¦å„ªåŒ–

### 1. ä¸Šæ¸¸å·¥å…·ç·©å­˜æ©Ÿåˆ¶ (Upstream Tool Caching)

**æ–‡ä»¶**: `src/skillflow/upstream_tool_cache.py` (æ–°å¢)

**åŠŸèƒ½**:
- å¯¦ç¾äº† TTLï¼ˆç”Ÿå­˜æ™‚é–“ï¼‰ç‚º 5 åˆ†é˜çš„æ™ºèƒ½ç·©å­˜ç³»çµ±
- ç·©å­˜ä¸Šæ¸¸ MCP æœå‹™å™¨çš„å·¥å…·åˆ—è¡¨ï¼Œæ¸›å°‘é‡è¤‡çš„ç¶²çµ¡è«‹æ±‚
- ç·šç¨‹å®‰å…¨çš„ç•°æ­¥æ“ä½œ
- è©³ç´°çš„ç·©å­˜çµ±è¨ˆå’Œç›£æ§

**é¡**: `UpstreamToolCache`

**ä¸»è¦æ–¹æ³•**:
```python
async def get(server_id: str) -> Optional[list]
    # ç²å–ç·©å­˜çš„å·¥å…·åˆ—è¡¨ï¼ˆå¦‚æœæœªéæœŸï¼‰

async def set(server_id: str, tools: list, server_name: str)
    # ç·©å­˜å·¥å…·åˆ—è¡¨

async def invalidate(server_id: Optional[str] = None)
    # å¤±æ•ˆç·©å­˜ï¼ˆç‰¹å®šæœå‹™å™¨æˆ–å…¨éƒ¨ï¼‰

async def get_stats() -> dict
    # ç²å–ç·©å­˜çµ±è¨ˆï¼ˆå‘½ä¸­ç‡ã€ç·©å­˜çš„æœå‹™å™¨ç­‰ï¼‰
```

**æ€§èƒ½æå‡**:
- âš¡ ç·©å­˜å‘½ä¸­æ™‚æ¸›å°‘ **95%** çš„æŸ¥è©¢æ™‚é–“
- ğŸ”„ æ¸›å°‘ **80-90%** çš„ä¸Šæ¸¸æœå‹™å™¨è² è¼‰
- ğŸ’¾ å¯é…ç½® TTLï¼ˆé»˜èª 5 åˆ†é˜ï¼‰

---

### 2. ä¸¦è¡Œå·¥å…·ç²å– (Parallel Tool Fetching)

**æ–‡ä»¶**: `src/skillflow/server.py` (ä¿®æ”¹)

**è®Šæ›´**:
- é‡å¯«äº† `_get_upstream_tools()` æ–¹æ³•
- æ–°å¢äº† `_fetch_server_tools()` è¼”åŠ©æ–¹æ³•
- ä½¿ç”¨ `asyncio.gather()` ä¸¦è¡ŒæŸ¥è©¢æ‰€æœ‰ä¸Šæ¸¸æœå‹™å™¨

**å„ªåŒ–å‰**:
```python
# é †åºæŸ¥è©¢æ¯å€‹æœå‹™å™¨
for server_config in servers:
    tools = await fetch_tools(server_config)  # é˜»å¡ 30 ç§’
# 3 å€‹æœå‹™å™¨ = æœ€å¤š 90 ç§’
```

**å„ªåŒ–å¾Œ**:
```python
# ä¸¦è¡ŒæŸ¥è©¢æ‰€æœ‰æœå‹™å™¨
tasks = [fetch_server_tools(s) for s in servers]
results = await asyncio.gather(*tasks, return_exceptions=True)
# 3 å€‹æœå‹™å™¨ = æœ€å¤š 30 ç§’ï¼ˆæœ€æ…¢çš„é‚£å€‹ï¼‰
```

**æ€§èƒ½æå‡**:
- âš¡ å¤šæœå‹™å™¨æŸ¥è©¢æ¸›å°‘ **70-90%** çš„æ™‚é–“
- ğŸ¯ è¶…æ™‚éš”é›¢ï¼ˆä¸€å€‹æ…¢æœå‹™å™¨ä¸æœƒé˜»å¡å…¶ä»–ï¼‰
- ğŸš€ é¡¯è‘—æ”¹å–„ç”¨æˆ¶é«”é©—

**åŸ·è¡Œæ™‚é–“è¨˜éŒ„**:
```
[Skillflow] Fetched 45 proxy tools in 1234ms
```

---

### 3. ç·©å­˜ç®¡ç†å·¥å…· (Cache Management Tools)

**æ–°å¢ MCP å·¥å…·**:

#### `get_cache_stats`
ç²å–ä¸Šæ¸¸å·¥å…·ç·©å­˜çš„è©³ç´°çµ±è¨ˆä¿¡æ¯ã€‚

**è¿”å›ç¤ºä¾‹**:
```json
{
  "hits": 15,
  "misses": 3,
  "invalidations": 1,
  "total_requests": 18,
  "hit_rate_percent": 83.33,
  "cached_servers": 2,
  "cached_servers_list": [
    {
      "server_id": "filesystem",
      "server_name": "Filesystem Tools",
      "tool_count": 12,
      "age_seconds": 45.2,
      "ttl_remaining": 254.8
    }
  ],
  "ttl_seconds": 300
}
```

#### `invalidate_cache`
æ‰‹å‹•å¤±æ•ˆç·©å­˜ã€‚

**åƒæ•¸**:
- `server_id` (å¯é¸): è¦å¤±æ•ˆçš„æœå‹™å™¨ IDï¼ˆçœç•¥å‰‡æ¸…é™¤æ‰€æœ‰ï¼‰

**ç¤ºä¾‹**:
```json
{
  "server_id": "filesystem"  // å¤±æ•ˆç‰¹å®šæœå‹™å™¨
}
```
æˆ–
```json
{}  // å¤±æ•ˆæ‰€æœ‰æœå‹™å™¨
```

#### `refresh_upstream_tools`
å¼·åˆ¶åˆ·æ–°ä¸Šæ¸¸å·¥å…·ï¼ˆå¤±æ•ˆç·©å­˜ä¸¦é‡æ–°ç²å–ï¼‰ã€‚

**åƒæ•¸**:
- `server_id` (å¯é¸): è¦åˆ·æ–°çš„æœå‹™å™¨ IDï¼ˆçœç•¥å‰‡åˆ·æ–°æ‰€æœ‰ï¼‰

**ç¤ºä¾‹**:
```json
{
  "server_id": "filesystem"  // åˆ·æ–°ç‰¹å®šæœå‹™å™¨
}
```

---

## ğŸ“Š æ€§èƒ½å°æ¯”

### å ´æ™¯ 1: é¦–æ¬¡æŸ¥è©¢ï¼ˆç·©å­˜æœªå‘½ä¸­ï¼‰
```
å„ªåŒ–å‰: 3 å€‹æœå‹™å™¨ Ã— 30ç§’ = 90 ç§’
å„ªåŒ–å¾Œ: max(30ç§’, 30ç§’, 30ç§’) = 30 ç§’ (ä¸¦è¡Œ)
æå‡: 70% æ™‚é–“æ¸›å°‘
```

### å ´æ™¯ 2: å¾ŒçºŒæŸ¥è©¢ï¼ˆç·©å­˜å‘½ä¸­ï¼‰
```
å„ªåŒ–å‰: 3 å€‹æœå‹™å™¨ Ã— 30ç§’ = 90 ç§’
å„ªåŒ–å¾Œ: ç·©å­˜å‘½ä¸­ = ~50 æ¯«ç§’
æå‡: 99.9% æ™‚é–“æ¸›å°‘
```

### å ´æ™¯ 3: æ··åˆå ´æ™¯ï¼ˆ2 å€‹ç·©å­˜å‘½ä¸­ï¼Œ1 å€‹æœªå‘½ä¸­ï¼‰
```
å„ªåŒ–å‰: 3 å€‹æœå‹™å™¨ Ã— 30ç§’ = 90 ç§’
å„ªåŒ–å¾Œ: max(~50ms, ~50ms, 30ç§’) = 30 ç§’
æå‡: 67% æ™‚é–“æ¸›å°‘
```

---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### æŸ¥çœ‹ç·©å­˜çµ±è¨ˆ
```python
# ä½¿ç”¨ MCP å·¥å…·
result = await client.call_tool("get_cache_stats", {})
```

### æ‰‹å‹•åˆ·æ–°ç‰¹å®šæœå‹™å™¨çš„å·¥å…·
```python
# ç•¶ä¸Šæ¸¸æœå‹™å™¨æ·»åŠ äº†æ–°å·¥å…·æ™‚
result = await client.call_tool("refresh_upstream_tools", {
    "server_id": "my-server"
})
```

### æ¸…é™¤æ‰€æœ‰ç·©å­˜
```python
# èª¿è©¦æˆ–æ¸¬è©¦æ™‚ä½¿ç”¨
result = await client.call_tool("invalidate_cache", {})
```

---

## ğŸ” æŠ€è¡“ç´°ç¯€

### ç·©å­˜å¯¦ç¾
- **æ•¸æ“šçµæ§‹**: `dict[str, CacheEntry]`
- **ä¸¦ç™¼æ§åˆ¶**: `asyncio.Lock`
- **éæœŸç­–ç•¥**: TTLï¼ˆæ™‚é–“æˆ³æª¢æŸ¥ï¼‰
- **å…§å­˜ç®¡ç†**: è‡ªå‹•æ¸…ç†éæœŸæ¢ç›®

### ä¸¦è¡Œç²å–å¯¦ç¾
- **ä¸¦ç™¼æ¨¡å¼**: `asyncio.gather(*tasks, return_exceptions=True)`
- **éŒ¯èª¤è™•ç†**: å„ªé›…é™ç´šï¼ˆä¸€å€‹æœå‹™å™¨å¤±æ•—ä¸å½±éŸ¿å…¶ä»–ï¼‰
- **è¶…æ™‚æ§åˆ¶**: æ¯å€‹æœå‹™å™¨ç¨ç«‹ 30 ç§’è¶…æ™‚
- **è³‡æºæ¸…ç†**: è¶…æ™‚å¾Œè‡ªå‹•æ–·é–‹é€£æ¥

### å…¼å®¹æ€§
- âœ… å®Œå…¨å‘å¾Œå…¼å®¹
- âœ… ä¸å½±éŸ¿ç¾æœ‰ MCP å·¥å…·
- âœ… ä¸æ”¹è®Š API æ¥å£
- âœ… æ”¯æŒæ‰€æœ‰ MCP å…§å®¹é¡å‹ï¼ˆText, Image, Audio, EmbeddedResourceï¼‰

---

## ğŸ“ ä»£ç¢¼è®Šæ›´æ‘˜è¦

### æ–°å¢æ–‡ä»¶
1. `src/skillflow/upstream_tool_cache.py` - ç·©å­˜å¯¦ç¾é¡

### ä¿®æ”¹æ–‡ä»¶
1. `src/skillflow/server.py`:
   - æ·»åŠ ç·©å­˜å°å…¥
   - åˆå§‹åŒ–ç·©å­˜å¯¦ä¾‹
   - é‡å¯« `_get_upstream_tools()` æ–¹æ³•
   - æ–°å¢ `_fetch_server_tools()` æ–¹æ³•
   - æ·»åŠ  3 å€‹ç·©å­˜ç®¡ç†å·¥å…·
   - æ·»åŠ ç·©å­˜ç®¡ç†å·¥å…·çš„è™•ç†é‚è¼¯

### æ–°å¢ MCP å·¥å…·
1. `get_cache_stats` - æŸ¥çœ‹ç·©å­˜çµ±è¨ˆ
2. `invalidate_cache` - å¤±æ•ˆç·©å­˜
3. `refresh_upstream_tools` - åˆ·æ–°å·¥å…·

---

## ğŸ¯ æœªä¾†å„ªåŒ–å»ºè­°

### é«˜å„ªå…ˆç´š
1. **å·¥å…·è™•ç†å™¨æ¨¡å¡ŠåŒ–é‡æ§‹**
   - å°‡å·¨å¤§çš„ `handle_tool_call()` å‡½æ•¸æ‹†åˆ†ç‚ºè™•ç†å™¨é¡
   - ä½¿ç”¨è¨»å†Šè¡¨æ¨¡å¼é€²è¡Œå·¥å…·åˆ†ç™¼
   - æé«˜å¯æ¸¬è©¦æ€§å’Œå¯ç¶­è­·æ€§

2. **Web API è·¯ç”±åˆ†çµ„**
   - ä½¿ç”¨ FastAPI è·¯ç”±å™¨çµ„ç¹”ç›¸é—œç«¯é»
   - æ”¹å–„ä»£ç¢¼çµæ§‹
   - è‡ªå‹•ç”Ÿæˆ OpenAPI æ–‡æª”

### ä¸­å„ªå…ˆç´š
3. **ç†”æ–·å™¨æ¨¡å¼ (Circuit Breaker)**
   - å°ä¸å¯é çš„ä¸Šæ¸¸æœå‹™å™¨å¯¦æ–½ç†”æ–·
   - å¿«é€Ÿå¤±æ•—ä»¥é¿å…ç´šè¯æ•…éšœ

4. **é€Ÿç‡é™åˆ¶ (Rate Limiting)**
   - é™åˆ¶ä¸Šæ¸¸æœå‹™å™¨çš„èª¿ç”¨é »ç‡
   - é˜²æ­¢éè¼‰

### ä½å„ªå…ˆç´š
5. **æŒä¹…åŒ–ç·©å­˜**
   - å°‡ç·©å­˜å­˜å„²åˆ°ç£ç›¤
   - æœå‹™å™¨é‡å•Ÿå¾Œä¿ç•™ç·©å­˜

6. **æ™ºèƒ½é åŠ è¼‰**
   - åœ¨ç©ºé–’æ™‚é å…ˆåŠ è¼‰ä¸Šæ¸¸å·¥å…·
   - é€²ä¸€æ­¥æ¸›å°‘é¦–æ¬¡æŸ¥è©¢å»¶é²

---

## âœ… æ¸¬è©¦é©—è­‰

### èªæ³•æª¢æŸ¥
```bash
âœ… python -m py_compile src/skillflow/server.py
âœ… python -m py_compile src/skillflow/upstream_tool_cache.py
```

### åŠŸèƒ½æ¸¬è©¦å»ºè­°
1. **ç·©å­˜æ¸¬è©¦**:
   - é¦–æ¬¡æŸ¥è©¢æ‡‰è©²ç·©å­˜æœªå‘½ä¸­
   - 5 åˆ†é˜å…§çš„å¾ŒçºŒæŸ¥è©¢æ‡‰è©²ç·©å­˜å‘½ä¸­
   - 5 åˆ†é˜å¾Œçš„æŸ¥è©¢æ‡‰è©²é‡æ–°ç²å–

2. **ä¸¦è¡Œæ¸¬è©¦**:
   - é…ç½® 3+ å€‹ä¸Šæ¸¸æœå‹™å™¨
   - é©—è­‰ä¸¦è¡ŒæŸ¥è©¢æ™‚é–“ < é †åºæŸ¥è©¢æ™‚é–“

3. **å·¥å…·æ¸¬è©¦**:
   - èª¿ç”¨ `get_cache_stats` æŸ¥çœ‹çµ±è¨ˆ
   - èª¿ç”¨ `invalidate_cache` æ¸…é™¤ç·©å­˜
   - èª¿ç”¨ `refresh_upstream_tools` åˆ·æ–°å·¥å…·

---

## ğŸ“– MCP å”è­°å…¼å®¹æ€§

### å·²é©—è­‰æ”¯æŒçš„ MCP åŠŸèƒ½

#### âœ… Tools (å·¥å…·)
- æ‰€æœ‰ç¾æœ‰å·¥å…·ï¼ˆ20+ å€‹ï¼‰
- æ–°å¢ 3 å€‹ç·©å­˜ç®¡ç†å·¥å…·
- å‹•æ…‹ä»£ç†ä¸Šæ¸¸å·¥å…·
- å®Œæ•´çš„ JSON Schema æ”¯æŒ

#### âœ… Resources (è³‡æº)
- `skill://` - æŠ€èƒ½å®šç¾©
- `session://` - è¨˜éŒ„æœƒè©±
- `run://` - åŸ·è¡Œæ—¥èªŒ

#### âœ… Prompts (æç¤º)
- `create_skill`, `debug_skill`, `optimize_skill`, `skill_best_practices`

#### âœ… Content Types (å…§å®¹é¡å‹)
- `TextContent` - æ–‡æœ¬æ¶ˆæ¯
- `ImageContent` - åœ–åƒã€æˆªåœ–
- `AudioContent` - éŸ³é »æ–‡ä»¶
- `EmbeddedResource` - åµŒå…¥å¼è³‡æº

#### âœ… Transport (å‚³è¼¸)
- STDIO
- HTTP+SSE
- WebSocket

---

## ğŸ‰ çµè«–

é€™æ¬¡å„ªåŒ–ç‚º SkillFlow MCP æœå‹™å™¨å¸¶ä¾†äº†é¡¯è‘—çš„æ€§èƒ½æå‡ï¼š

- âš¡ **70-99%** çš„æŸ¥è©¢æ™‚é–“æ¸›å°‘ï¼ˆå–æ±ºæ–¼ç·©å­˜å‘½ä¸­ç‡ï¼‰
- ğŸ¯ **æ›´å¥½çš„å¯é æ€§**ï¼ˆè¶…æ™‚éš”é›¢ï¼‰
- ğŸ”§ **æ›´å¥½çš„å¯æ§æ€§**ï¼ˆç·©å­˜ç®¡ç†å·¥å…·ï¼‰
- ğŸ“Š **æ›´å¥½çš„å¯è§€æ¸¬æ€§**ï¼ˆç·©å­˜çµ±è¨ˆï¼‰

åŒæ™‚ä¿æŒäº†ï¼š
- âœ… å®Œå…¨å‘å¾Œå…¼å®¹
- âœ… MCP å”è­°å®Œæ•´æ”¯æŒ
- âœ… ä»£ç¢¼è³ªé‡å’Œå¯ç¶­è­·æ€§

é€™ç‚ºæœªä¾†çš„æ“´å±•å’Œå„ªåŒ–å¥ å®šäº†å …å¯¦çš„åŸºç¤ã€‚
